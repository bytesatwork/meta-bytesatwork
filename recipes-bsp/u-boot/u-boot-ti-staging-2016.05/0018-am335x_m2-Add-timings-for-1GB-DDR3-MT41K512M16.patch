From 7db40ca539b83f9a68295374a2ef3965b2850af5 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stephan=20D=C3=BCnner?= <stephan.duenner@bytesatwork.ch>
Date: Fri, 25 Aug 2017 15:50:20 +0200
Subject: [PATCH 18/18] am335x_m2: Add timings for 1GB DDR3 MT41K512M16

---
 arch/arm/include/asm/arch-am33xx/ddr_defs.h  | 15 +++++++
 board/bytesatwork/am335x/m2config/m2config.c | 10 +++--
 board/bytesatwork/am335x/m2config/m2config.h | 10 +++--
 board/bytesatwork/am335x/ram.c               | 58 ++++++++++++++++++++++++++++
 include/configs/am335x_m2_emmc.h             |  1 +
 5 files changed, 86 insertions(+), 8 deletions(-)

diff --git a/arch/arm/include/asm/arch-am33xx/ddr_defs.h b/arch/arm/include/asm/arch-am33xx/ddr_defs.h
index 4416eeceef..f7ab581d0d 100644
--- a/arch/arm/include/asm/arch-am33xx/ddr_defs.h
+++ b/arch/arm/include/asm/arch-am33xx/ddr_defs.h
@@ -196,6 +196,21 @@
 #define K4B4G1646DBIK0_PHY_WR_DATA		0x76
 #define K4B4G1646DBIK0_IOCTRL_VALUE		0x18B
 
+/* Micron MT41K512M16HA-107 IT:A D9SGD (1024MB DDR3) */
+#define MT41K512M16HA107_EMIF_READ_LATENCY        0x100007
+#define MT41K512M16HA107_EMIF_TIM1                0x0AA15CA3
+#define MT41K512M16HA107_EMIF_TIM2                0x2A8F7FDA
+#define MT41K512M16HA107_EMIF_TIM3                0x501F88BF
+#define MT41K512M16HA107_EMIF_SDCFG               0x61C04BB2
+#define MT41K512M16HA107_EMIF_SDREF               0x0000093B
+#define MT41K512M16HA107_ZQ_CFG                   0x50074BE4
+#define MT41K512M16HA107_RATIO                    0x80
+#define MT41K512M16HA107_INVERT_CLKOUT            0x0
+#define MT41K512M16HA107_RD_DQS                   0x35
+#define MT41K512M16HA107_WR_DQS                   0x3A
+#define MT41K512M16HA107_PHY_FIFO_WE              0x79
+#define MT41K512M16HA107_PHY_WR_DATA              0x76
+#define MT41K512M16HA107_IOCTRL_VALUE             0x18B
 
 #define  LPDDR2_ADDRCTRL_IOCTRL_VALUE   0x294
 #define  LPDDR2_ADDRCTRL_WD0_IOCTRL_VALUE 0x00000000
diff --git a/board/bytesatwork/am335x/m2config/m2config.c b/board/bytesatwork/am335x/m2config/m2config.c
index 5d462c8e99..ddbb63d9f5 100644
--- a/board/bytesatwork/am335x/m2config/m2config.c
+++ b/board/bytesatwork/am335x/m2config/m2config.c
@@ -12,6 +12,7 @@ const struct m2config_name_pair m2config_pcb_name[] = {
 	{ M2_PCB_REV_01, "Rev.01" },
 	{ M2_PCB_REV_02, "Rev.02" },
 	{ M2_PCB_REV_03, "Rev.03" },
+	{ M2_PCB_REV_04, "Rev.04" },
 	{ -1, NULL },
 };
 
@@ -20,16 +21,17 @@ const struct m2config_name_pair m2config_ram_name[] = {
 	{ M2_RAM_K4B2G1646EBIH9,   "K4B2G1646EBIH9 legacy DDR3 @ 303MHz" },
 	{ M2_RAM_K4B2G1646QBCK0,   "K4B2G1646QBCK0 256 MB DDR3 @ 400Mhz" },
 	{ M2_RAM_K4B4G1646DBIK0,   "K4B4G1646DBIK0 512 MB DDR3 @ 400MHz" },
+	{ M2_RAM_MT41K512M16HA107, "MT41K512M16HA107 1024MB DDR3 @ 303MHz" },
 	{ -1, NULL },
 };
 
 const struct m2config_name_pair m2config_flash_name[] = {
 	{ M2_NAND_2GBIT, "Nand 2 GBit" },
 	{ M2_NAND_4GBIT, "Nand 4 GBit" },
-	{ M2_EMMC_4GBIT, "EMMC 4 GBit" },
-	{ M2_EMMC_8GBIT, "EMMC 8 GBit" },
-	{ M2_EMMC_16GBIT, "EMMC 16 GBit" },
-	{ M2_EMMC_32GBIT, "EMMC 32 GBit" },
+	{ M2_EMMC_4GB, "EMMC 4 GB" },
+	{ M2_EMMC_8GB, "EMMC 8 GB" },
+	{ M2_EMMC_16GB, "EMMC 16 GB" },
+	{ M2_EMMC_32GB, "EMMC 32 GB" },
 	{ -1, NULL },
 };
 
diff --git a/board/bytesatwork/am335x/m2config/m2config.h b/board/bytesatwork/am335x/m2config/m2config.h
index 0570d7ed90..e70fd8b02c 100644
--- a/board/bytesatwork/am335x/m2config/m2config.h
+++ b/board/bytesatwork/am335x/m2config/m2config.h
@@ -22,6 +22,7 @@ typedef enum
 	M2_PCB_REV_01 = 1,
 	M2_PCB_REV_02 = 2,
 	M2_PCB_REV_03 = 3,
+	M2_PCB_REV_04 = 4,
 } m2config_pcb_t;
 
 typedef enum
@@ -30,16 +31,17 @@ typedef enum
 	M2_RAM_K4B2G1646EBIH9   = 2,
 	M2_RAM_K4B2G1646QBCK0   = 3,
 	M2_RAM_K4B4G1646DBIK0   = 4,
+	M2_RAM_MT41K512M16HA107 = 5,
 } m2config_ram_t;
 
 typedef enum
 {
 	M2_NAND_2GBIT  = 0,
 	M2_NAND_4GBIT  = 1,
-	M2_EMMC_4GBIT  = 2,
-	M2_EMMC_8GBIT  = 3,
-	M2_EMMC_16GBIT = 4,
-	M2_EMMC_32GBIT = 5,
+	M2_EMMC_4GB  = 2,
+	M2_EMMC_8GB  = 3,
+	M2_EMMC_16GB = 4,
+	M2_EMMC_32GB = 5,
 } m2config_flash_t;
 
 struct m2config {
diff --git a/board/bytesatwork/am335x/ram.c b/board/bytesatwork/am335x/ram.c
index b00d4a061c..d3665d4adf 100644
--- a/board/bytesatwork/am335x/ram.c
+++ b/board/bytesatwork/am335x/ram.c
@@ -236,6 +236,63 @@ static const struct dpll_params K4B4G1646DBIK0_dpll = {
 	1, -1, -1, -1, -1
 };
 
+/* DDR3 1024MB MT41K512M16HA-107 IT:A 	D9SGD --------------------------------*/
+
+static const struct ctrl_ioregs MT41K512M16HA107_ctrl_ioregs = {
+	.cm0ioctl               = MT41K512M16HA107_IOCTRL_VALUE,
+	.cm1ioctl               = MT41K512M16HA107_IOCTRL_VALUE,
+	.cm2ioctl               = MT41K512M16HA107_IOCTRL_VALUE,
+	.dt0ioctl               = MT41K512M16HA107_IOCTRL_VALUE,
+	.dt1ioctl               = MT41K512M16HA107_IOCTRL_VALUE,
+};
+
+static const struct ddr_data MT41K512M16HA107_ddr_data = {
+	.datardsratio0		= MT41K512M16HA107_RD_DQS,
+	.datawdsratio0		= MT41K512M16HA107_WR_DQS,
+	.datafwsratio0		= MT41K512M16HA107_PHY_FIFO_WE,
+	.datawrsratio0		= MT41K512M16HA107_PHY_WR_DATA,
+};
+
+static const struct cmd_control MT41K512M16HA107_cmd_control = {
+	.cmd0csratio		= MT41K512M16HA107_RATIO,
+	.cmd0iclkout		= MT41K512M16HA107_INVERT_CLKOUT,
+
+	.cmd1csratio		= MT41K512M16HA107_RATIO,
+	.cmd1iclkout		= MT41K512M16HA107_INVERT_CLKOUT,
+
+	.cmd2csratio		= MT41K512M16HA107_RATIO,
+	.cmd2iclkout		= MT41K512M16HA107_INVERT_CLKOUT,
+};
+
+static const struct emif_regs MT41K512M16HA107_emif_regs = {
+	.sdram_config		= MT41K512M16HA107_EMIF_SDCFG,
+	.ref_ctrl		= MT41K512M16HA107_EMIF_SDREF,
+	.sdram_tim1		= MT41K512M16HA107_EMIF_TIM1,
+	.sdram_tim2		= MT41K512M16HA107_EMIF_TIM2,
+	.sdram_tim3		= MT41K512M16HA107_EMIF_TIM3,
+	.zq_config		= MT41K512M16HA107_ZQ_CFG,
+	.emif_ddr_phy_ctlr_1	= MT41K512M16HA107_EMIF_READ_LATENCY,
+};
+
+#define MT41K512M16HA107_CLOCK_MHZ 303
+
+static void init_MT41K512M16HA107(void)
+{
+	config_ddr(MT41K512M16HA107_CLOCK_MHZ,
+		&MT41K512M16HA107_ctrl_ioregs,
+		&MT41K512M16HA107_ddr_data,
+		&MT41K512M16HA107_cmd_control,
+		&MT41K512M16HA107_emif_regs,
+		0);
+
+	mdelay(2);
+}
+
+static const struct dpll_params MT41K512M16HA107_dpll = {
+	MT41K512M16HA107_CLOCK_MHZ, OSC-1,
+	1, -1, -1, -1, -1
+};
+
 /* --------------------------------------------------------------------------- */
 
 struct ram_config {
@@ -249,6 +306,7 @@ const struct ram_config ram_init_map[] = {
 	{ M2_RAM_K4B2G1646EBIH9,   init_K4B2G1646EBIH9,   &K4B2G1646EBIH9_dpll },
 	{ M2_RAM_K4B2G1646QBCK0,   init_K4B2G1646QBCK0,   &K4B2G1646QBCK0_dpll },
 	{ M2_RAM_K4B4G1646DBIK0,   init_K4B4G1646DBIK0,   &K4B4G1646DBIK0_dpll },
+	{ M2_RAM_MT41K512M16HA107,   init_MT41K512M16HA107,   &MT41K512M16HA107_dpll },
 	{ -1, NULL }
 };
 
diff --git a/include/configs/am335x_m2_emmc.h b/include/configs/am335x_m2_emmc.h
index e8aa960588..51f1ace948 100644
--- a/include/configs/am335x_m2_emmc.h
+++ b/include/configs/am335x_m2_emmc.h
@@ -52,6 +52,7 @@
 	"spiflashsize=0x80000\0" \
 	"loadaddr=0x82000000\0" \
 	"dtbaddr=0x83000000\0" \
+	"fdt_high=0xffffffff\0" \
 	"console=ttyO0,115200n8\0" \
 	"mmc_root=/dev/mmcblk0p2\0" \
 	"emmc_root=/dev/mmcblk0p2\0" \
-- 
2.11.0

