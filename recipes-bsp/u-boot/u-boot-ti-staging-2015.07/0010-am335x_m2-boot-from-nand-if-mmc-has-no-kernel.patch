From 36ca0188e34654a6ff2deaa3109b7a43963a708b Mon Sep 17 00:00:00 2001
From: Daniel Ammann <daniel.ammann@bytesatwork.ch>
Date: Thu, 14 Jul 2016 17:55:31 +0200
Subject: [PATCH] am335x_m2: boot from nand if mmc has no kernel
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

It is easier to develop an application that writes to SD card because
an "empty" SD card will not prevent boot from flash.

Signed-off-by: Oliver St√§bler <oliver.staebler@bytesatwork.ch>
---
 include/configs/am335x_m2.h | 26 ++++++++++++++++++--------
 1 file changed, 18 insertions(+), 8 deletions(-)

diff --git a/include/configs/am335x_m2.h b/include/configs/am335x_m2.h
index 0960ad9..13c968c 100644
--- a/include/configs/am335x_m2.h
+++ b/include/configs/am335x_m2.h
@@ -134,22 +134,32 @@
 		"; " \
 	"\0" \
 	"mmc_boot=echo Booting from mmc ...; " \
-		"run mmc_args; " \
-		"fatload mmc 0 ${loadaddr} ${kernelfile}; " \
-		"fatload mmc 0 ${dtbaddr} ${dtbfile}; " \
-		"bootm ${loadaddr} - ${dtbaddr}; " \
-	"\0" \
-
+		"if fatsize mmc 0 ${kernelfile}; then " \
+			"echo Found kernel on MMC; " \
+			"if fatsize mmc 0 ${dtbfile}; then " \
+				"echo Found device tree on MMC; " \
+				"run mmc_args; " \
+				"fatload mmc 0 ${loadaddr} ${kernelfile}; " \
+				"fatload mmc 0 ${dtbaddr} ${dtbfile}; " \
+				"bootm ${loadaddr} - ${dtbaddr}; " \
+			"else " \
+				"echo Device tree not found on MMC; " \
+			"fi; " \
+		"else " \
+			"echo Kernel not found on MMC; " \
+		"fi; " \
+		"run nand_boot; " \
+	"\0"
 #endif
 
 #define CONFIG_BOOTCOMMAND \
 	"if mmc rescan; then " \
-		"echo SD/MMC found on device ${mmc_dev};" \
+		"echo SD/MMC found on device ${mmc_dev}; " \
 		"run nand_update; " \
 		"run mmc_boot; " \
 	"else " \
 		"run nand_boot; " \
-	"fi; "\
+	"fi; "
 
 #define CONFIG_CMD_M2CONFIG
 #define CONFIG_M2CONFIG_EEPROM
-- 
2.1.4

