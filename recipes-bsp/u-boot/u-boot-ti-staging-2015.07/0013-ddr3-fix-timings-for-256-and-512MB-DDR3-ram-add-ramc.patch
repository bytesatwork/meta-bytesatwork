From 46435599319b8af8457de51726fb5ea65bc9110b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stephan=20D=C3=BCnner?= <stephan.duenner@bytesatwork.ch>
Date: Thu, 3 Nov 2016 10:05:21 +0100
Subject: [PATCH 13/15] ddr3: fix timings for 256 and 512MB DDR3 ram, add
 ramconfig 3 for 512MB

---
 arch/arm/include/asm/arch-am33xx/ddr_defs.h |  33 ++++++++
 board/bytesatwork/am335x/ram.c              | 123 +++++++++++++++++++++++++++-
 2 files changed, 152 insertions(+), 4 deletions(-)

diff --git a/arch/arm/include/asm/arch-am33xx/ddr_defs.h b/arch/arm/include/asm/arch-am33xx/ddr_defs.h
index 43e122e..ea81975 100644
--- a/arch/arm/include/asm/arch-am33xx/ddr_defs.h
+++ b/arch/arm/include/asm/arch-am33xx/ddr_defs.h
@@ -155,6 +155,39 @@
 #define K4B2G1646EBIH9_PHY_WR_DATA		0x76
 #define K4B2G1646EBIH9_IOCTRL_VALUE		0x18B
 
+/* Samsung K4B2G1646Q-BCK0 (256MB DDR3) */
+#define K4B2G1646QBCK0_EMIF_READ_LATENCY	0x100007
+#define K4B2G1646QBCK0_EMIF_TIM1		0x0AAAE51B
+#define K4B2G1646QBCK0_EMIF_TIM2		0x2A437FDA
+#define K4B2G1646QBCK0_EMIF_TIM3		0x501F83FF
+#define K4B2G1646QBCK0_EMIF_SDCFG		0x61C052B2
+#define K4B2G1646QBCK0_EMIF_SDREF		0x00000C30
+#define K4B2G1646QBCK0_ZQ_CFG			0x50074BE4
+#define K4B2G1646QBCK0_RATIO			0x80
+#define K4B2G1646QBCK0_INVERT_CLKOUT		0x0
+#define K4B2G1646QBCK0_RD_DQS			0x35
+#define K4B2G1646QBCK0_WR_DQS			0x3A
+#define K4B2G1646QBCK0_PHY_FIFO_WE		0x97
+#define K4B2G1646QBCK0_PHY_WR_DATA		0x76
+#define K4B2G1646QBCK0_IOCTRL_VALUE		0x18B
+
+/* Samsung K4B4G1646D-BIK0 (512MB DDR3) */
+#define K4B4G1646DBIK0_EMIF_READ_LATENCY	0x100007
+#define K4B4G1646DBIK0_EMIF_TIM1		0x0AAAE51B
+#define K4B4G1646DBIK0_EMIF_TIM2		0x2A6B7FDA
+#define K4B4G1646DBIK0_EMIF_TIM3		0x501F867F
+#define K4B4G1646DBIK0_EMIF_SDCFG		0x61C052B2
+#define K4B4G1646DBIK0_EMIF_SDREF		0x00000C30
+#define K4B4G1646DBIK0_ZQ_CFG			0x50074BE4
+#define K4B4G1646DBIK0_RATIO			0x80
+#define K4B4G1646DBIK0_INVERT_CLKOUT		0x0
+#define K4B4G1646DBIK0_RD_DQS			0x35
+#define K4B4G1646DBIK0_WR_DQS			0x3A
+#define K4B4G1646DBIK0_PHY_FIFO_WE		0x97
+#define K4B4G1646DBIK0_PHY_WR_DATA		0x76
+#define K4B4G1646DBIK0_IOCTRL_VALUE		0x18B
+
+
 #define  LPDDR2_ADDRCTRL_IOCTRL_VALUE   0x294
 #define  LPDDR2_ADDRCTRL_WD0_IOCTRL_VALUE 0x00000000
 #define  LPDDR2_ADDRCTRL_WD1_IOCTRL_VALUE 0x00000000
diff --git a/board/bytesatwork/am335x/ram.c b/board/bytesatwork/am335x/ram.c
index 687ae08..1550a54 100644
--- a/board/bytesatwork/am335x/ram.c
+++ b/board/bytesatwork/am335x/ram.c
@@ -18,7 +18,7 @@ DECLARE_GLOBAL_DATA_PTR;
 
 #define OSC	(V_OSCK/1000000)
 
-
+/* 256 MB DDR2 -------------------------------------------------------------- */
 
 static const struct ctrl_ioregs MT47H128M16RT25E_ctrl_ioregs = {
 	.cm0ioctl		= MT47H128M16RT25E_IOCTRL_VALUE,
@@ -66,7 +66,7 @@ static const struct dpll_params MT47H128M16RT25E_dpll = {
 	1, -1, -1, -1, -1
 };
 
-
+/* DDR3 256 and 512 MB Legacy setting due to wrong programmed modules config 2 */
 
 static const struct ctrl_ioregs K4B2G1646EBIH9_ctrl_ioregs = {
 	.cm0ioctl               = K4B2G1646EBIH9_IOCTRL_VALUE,
@@ -104,7 +104,7 @@ static const struct emif_regs K4B2G1646EBIH9_emif_regs = {
 	.emif_ddr_phy_ctlr_1	= K4B2G1646EBIH9_EMIF_READ_LATENCY,
 };
 
-#define K4B2G1646EBIH9_CLOCK_MHZ	333
+#define K4B2G1646EBIH9_CLOCK_MHZ	303
 
 static void init_K4B2G1646EBIH9(void)
 {
@@ -123,7 +123,120 @@ static const struct dpll_params K4B2G1646EBIH9_dpll = {
 	1, -1, -1, -1, -1
 };
 
+/* DDR3 256 MB K4B2G1646Q-BCK0 ----------------------------------------------- */
+
+static const struct ctrl_ioregs K4B2G1646QBCK0_ctrl_ioregs = {
+	.cm0ioctl               = K4B2G1646QBCK0_IOCTRL_VALUE,
+	.cm1ioctl               = K4B2G1646QBCK0_IOCTRL_VALUE,
+	.cm2ioctl               = K4B2G1646QBCK0_IOCTRL_VALUE,
+	.dt0ioctl               = K4B2G1646QBCK0_IOCTRL_VALUE,
+	.dt1ioctl               = K4B2G1646QBCK0_IOCTRL_VALUE,
+};
+
+static const struct ddr_data K4B2G1646QBCK0_ddr_data = {
+	.datardsratio0		= K4B2G1646QBCK0_RD_DQS,
+	.datawdsratio0		= K4B2G1646QBCK0_WR_DQS,
+	.datafwsratio0		= K4B2G1646QBCK0_PHY_FIFO_WE,
+	.datawrsratio0		= K4B2G1646QBCK0_PHY_WR_DATA,
+};
+
+static const struct cmd_control K4B2G1646QBCK0_cmd_control = {
+	.cmd0csratio		= K4B2G1646QBCK0_RATIO,
+	.cmd0iclkout		= K4B2G1646QBCK0_INVERT_CLKOUT,
+
+	.cmd1csratio		= K4B2G1646QBCK0_RATIO,
+	.cmd1iclkout		= K4B2G1646QBCK0_INVERT_CLKOUT,
+
+	.cmd2csratio		= K4B2G1646QBCK0_RATIO,
+	.cmd2iclkout		= K4B2G1646QBCK0_INVERT_CLKOUT,
+};
+
+static const struct emif_regs K4B2G1646QBCK0_emif_regs = {
+	.sdram_config		= K4B2G1646QBCK0_EMIF_SDCFG,
+	.ref_ctrl		= K4B2G1646QBCK0_EMIF_SDREF,
+	.sdram_tim1		= K4B2G1646QBCK0_EMIF_TIM1,
+	.sdram_tim2		= K4B2G1646QBCK0_EMIF_TIM2,
+	.sdram_tim3		= K4B2G1646QBCK0_EMIF_TIM3,
+	.zq_config		= K4B2G1646QBCK0_ZQ_CFG,
+	.emif_ddr_phy_ctlr_1	= K4B2G1646QBCK0_EMIF_READ_LATENCY,
+};
+
+#define K4B2G1646QBCK0_CLOCK_MHZ	400
+
+static void init_K4B2G1646QBCK0(void)
+{
+	config_ddr(K4B2G1646QBCK0_CLOCK_MHZ,
+		&K4B2G1646QBCK0_ctrl_ioregs,
+		&K4B2G1646QBCK0_ddr_data,
+		&K4B2G1646QBCK0_cmd_control,
+		&K4B2G1646QBCK0_emif_regs,
+		0);
+
+	mdelay(2);
+}
+
+static const struct dpll_params K4B2G1646QBCK0_dpll = {
+	K4B2G1646QBCK0_CLOCK_MHZ, OSC-1,
+	1, -1, -1, -1, -1
+};
+
+/* DDR3 512MB K4B4G1646D------------------------------------------------------ */
+static const struct ctrl_ioregs K4B4G1646DBIK0_ctrl_ioregs = {
+	.cm0ioctl               = K4B4G1646DBIK0_IOCTRL_VALUE,
+	.cm1ioctl               = K4B4G1646DBIK0_IOCTRL_VALUE,
+	.cm2ioctl               = K4B4G1646DBIK0_IOCTRL_VALUE,
+	.dt0ioctl               = K4B4G1646DBIK0_IOCTRL_VALUE,
+	.dt1ioctl               = K4B4G1646DBIK0_IOCTRL_VALUE,
+};
+
+static const struct ddr_data K4B4G1646DBIK0_ddr_data = {
+	.datardsratio0		= K4B4G1646DBIK0_RD_DQS,
+	.datawdsratio0		= K4B4G1646DBIK0_WR_DQS,
+	.datafwsratio0		= K4B4G1646DBIK0_PHY_FIFO_WE,
+	.datawrsratio0		= K4B4G1646DBIK0_PHY_WR_DATA,
+};
+
+static const struct cmd_control K4B4G1646DBIK0_cmd_control = {
+	.cmd0csratio		= K4B4G1646DBIK0_RATIO,
+	.cmd0iclkout		= K4B4G1646DBIK0_INVERT_CLKOUT,
+
+	.cmd1csratio		= K4B4G1646DBIK0_RATIO,
+	.cmd1iclkout		= K4B4G1646DBIK0_INVERT_CLKOUT,
+
+	.cmd2csratio		= K4B4G1646DBIK0_RATIO,
+	.cmd2iclkout		= K4B4G1646DBIK0_INVERT_CLKOUT,
+};
+
+static const struct emif_regs K4B4G1646DBIK0_emif_regs = {
+	.sdram_config		= K4B4G1646DBIK0_EMIF_SDCFG,
+	.ref_ctrl		= K4B4G1646DBIK0_EMIF_SDREF,
+	.sdram_tim1		= K4B4G1646DBIK0_EMIF_TIM1,
+	.sdram_tim2		= K4B4G1646DBIK0_EMIF_TIM2,
+	.sdram_tim3		= K4B4G1646DBIK0_EMIF_TIM3,
+	.zq_config		= K4B4G1646DBIK0_ZQ_CFG,
+	.emif_ddr_phy_ctlr_1	= K4B4G1646DBIK0_EMIF_READ_LATENCY,
+};
+
+#define K4B4G1646DBIK0_CLOCK_MHZ	400
+
+static void init_K4B4G1646DBIK0(void)
+{
+	config_ddr(K4B4G1646DBIK0_CLOCK_MHZ,
+		&K4B4G1646DBIK0_ctrl_ioregs,
+		&K4B4G1646DBIK0_ddr_data,
+		&K4B4G1646DBIK0_cmd_control,
+		&K4B4G1646DBIK0_emif_regs,
+		0);
+
+	mdelay(2);
+}
+
+static const struct dpll_params K4B4G1646DBIK0_dpll = {
+	K4B4G1646DBIK0_CLOCK_MHZ, OSC-1,
+	1, -1, -1, -1, -1
+};
 
+/* --------------------------------------------------------------------------- */
 
 struct ram_config {
 	m2config_ram_t	config;
@@ -134,6 +247,8 @@ struct ram_config {
 const struct ram_config ram_init_map[] = {
 	{ M2_RAM_MT47H128M16RT25E, init_MT47H128M16RT25E, &MT47H128M16RT25E_dpll },
 	{ M2_RAM_K4B2G1646EBIH9,   init_K4B2G1646EBIH9,   &K4B2G1646EBIH9_dpll },
+	{ M2_RAM_K4B2G1646QBCK0,   init_K4B2G1646QBCK0,   &K4B2G1646QBCK0_dpll },
+	{ M2_RAM_K4B4G1646DBIK0,   init_K4B4G1646DBIK0,   &K4B4G1646DBIK0_dpll },
 	{ -1, NULL }
 };
 
@@ -156,7 +271,7 @@ static const struct ram_config *getRam(void)
 		ram = findRam(config.ram);
 
 	if (ram == NULL)
-		ram = &ram_init_map[0];
+		ram = &ram_init_map[1]; /* set default to legacy DDR3 */
 
 	return ram;
 }
-- 
2.1.4

