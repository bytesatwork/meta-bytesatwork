From 978d53532e9bfe23cafa22c08a111d1cc0ac0841 Mon Sep 17 00:00:00 2001
From: Daniel Ammann <daniel.ammann@bytesatwork.ch>
Date: Tue, 7 Aug 2018 12:05:51 +0200
Subject: [PATCH] video/logo: Make it possible to select logo from device tree

---
 drivers/video/logo/Kconfig |  3 +++
 drivers/video/logo/logo.c  | 35 +++++++++++++++++++++++++++++++++++
 2 files changed, 38 insertions(+)

diff --git a/drivers/video/logo/Kconfig b/drivers/video/logo/Kconfig
index f8db82db00fd..b92ad1b607a7 100644
--- a/drivers/video/logo/Kconfig
+++ b/drivers/video/logo/Kconfig
@@ -15,6 +15,9 @@ config FB_LOGO_EXTRA
 	depends on FB=y
 	default y if SPU_BASE
 
+config LOGO_OF_SELECT
+	bool "Select logo from device tree"
+
 config LOGO_LINUX_MONO
 	bool "Standard black and white Linux logo"
 	default y
diff --git a/drivers/video/logo/logo.c b/drivers/video/logo/logo.c
index 99b055cd2386..49586aac952f 100644
--- a/drivers/video/logo/logo.c
+++ b/drivers/video/logo/logo.c
@@ -17,6 +17,9 @@
 #include <asm/setup.h>
 #endif
 
+#include <linux/of_device.h>
+#include <linux/of_platform.h>
+
 static bool nologo;
 module_param(nologo, bool, 0);
 MODULE_PARM_DESC(nologo, "Disables startup logo");
@@ -44,6 +47,11 @@ const struct linux_logo * __ref fb_find_logo(int depth)
 {
 	const struct linux_logo *logo = NULL;
 
+#ifdef CONFIG_LOGO_OF_SELECT
+	struct device_node *of_chosen;
+	const char *of_logo = NULL;
+#endif
+
 	if (nologo || logos_freed)
 		return NULL;
 
@@ -120,6 +128,33 @@ const struct linux_logo * __ref fb_find_logo(int depth)
 #ifdef CONFIG_LOGO_BAW_480X272_CLUT224
 		logo = &logo_baw_480x272_clut224;
 #endif
+
+#ifdef CONFIG_LOGO_OF_SELECT
+		of_chosen = of_find_node_by_path("/chosen");
+		if (of_chosen == NULL)
+			of_chosen = of_find_node_by_path("/chosen@0");
+
+		if (of_chosen != NULL) {
+			of_property_read_string(of_chosen, "logo", &of_logo);
+			if (of_logo) {
+#ifdef CONFIG_LOGO_BAW_1024X600_CLUT224
+				if (!strcmp(of_logo, "baw_1024x600")) {
+					logo = &logo_baw_1024x600_clut224;
+				}
+#endif
+#ifdef CONFIG_LOGO_BAW_800X480_CLUT224
+				if (!strcmp(of_logo, "baw_800x480")) {
+					logo = &logo_baw_800x480_clut224;
+				}
+#endif
+#ifdef CONFIG_LOGO_BAW_480X272_CLUT224
+				if (!strcmp(of_logo, "baw_480x272")) {
+					logo = &logo_baw_480x272_clut224;
+				}
+#endif
+			}
+		}
+#endif
 	}
 	return logo;
 }
-- 
2.11.0

